@model SagPoc.Web.Models.FormMetadata
@using SagPoc.Web.Models

<form id="dynamicForm" class="needs-validation" novalidate>
    <input type="hidden" id="editingRecordId" name="editingRecordId" value="" data-pk-field="@Model.PkColumnName" />

    @{
        var bevelGroups = Model.GetBevelGroups();
    }

    @foreach (var group in bevelGroups)
    {
        if (group.HasBevel)
        {
            <fieldset class="bevel-group">
                @* Usa HasBevelCaption (LbcxCamp != 0) para determinar se mostra o label *@
                @if (group.Bevel!.HasBevelCaption && !string.IsNullOrEmpty(group.Bevel.LabeCamp))
                {
                    <legend>@group.Bevel.LabeCamp</legend>
                }
                <div class="bevel-content">
                    @{
                        var fieldRows = group.GetFieldRows();
                    }
                    @foreach (var row in fieldRows)
                    {
                        @await Html.PartialAsync("_FieldRowRenderer", row)
                    }
                </div>
            </fieldset>
        }
        else
        {
            <div class="orphan-fields">
                @{
                    var orphanRows = group.GetFieldRows();
                }
                @foreach (var row in orphanRows)
                {
                    @await Html.PartialAsync("_FieldRowRenderer", row)
                }
            </div>
        }
    }

    <hr class="my-4" />

    <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="bi bi-check-lg"></i> Salvar
        </button>
        <button type="button" class="btn btn-outline-secondary" id="btnCancelar">
            <i class="bi bi-x-lg"></i> Cancelar
        </button>
    </div>
</form>

<script>
    document.getElementById('btnCancelar')?.addEventListener('click', function() {
        // Verifica se estamos em modo de inclusão com Saga Pattern
        if (window.formState && window.formState.isNewRecord && window.formState.recordId) {
            // Chama cancelNewRecord que deleta o registro e movimentos em cascata
            if (typeof cancelNewRecord === 'function') {
                cancelNewRecord();
                return;
            }
        }

        // Comportamento padrão: volta para a tab Consulta
        document.getElementById('tab-consulta-tab')?.click();
    });
</script>
